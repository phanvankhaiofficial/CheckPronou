<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kiểm tra phát âm tiếng Nhật</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Arial", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
      }
      .container {
        background-color: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-width: 500px;
        width: 100%;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      input,
      button,
      textarea {
        /* Thêm textarea vào đây */
        width: 100%; /* Đảm bảo chiều rộng bằng 100% */
        padding: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px; /* Thêm khoảng cách giữa các nút */
      }
      button:hover {
        opacity: 0.9; /* Hiệu ứng khi hover */
      }
      #result {
        margin-top: 1rem;
        font-size: 1.1rem;
        line-height: 1.5;
        min-height: 150px; /* Đặt chiều cao tối thiểu cho khu vực kết quả */
      }
      .correct {
        color: green;
      }
      .incorrect {
        color: red;
      }
      .hidden {
        visibility: hidden;
      }
      .score-good {
        color: green; /* Màu xanh cho điểm trên 70% */
      }
      .score-bad {
        color: red; /* Màu đỏ cho điểm dưới 70% */
      }
      textarea {
        /* Thêm CSS cho textarea */
        height: 150px; /* Chiều cao của textarea */
        resize: vertical; /* Cho phép thay đổi kích thước theo chiều dọc */
      }
      #nextButton {
        /* Thay đổi màu cho nút Kế tiếp */
        background-color: #e71e94; /* Màu xanh dương cho nút Kế tiếp */
      }
      #nextButton:hover {
        background-color: #b3066b; /* Màu xanh đậm khi hover */
      }
      #recordButton {
        background-color: #28a745; /* Màu xanh cho nút Bắt đầu ghi âm */
      }
      #recordButton:hover {
        background-color: #218838; /* Màu xanh đậm khi hover */
      }
      #showTextButton {
        background-color: #ffc107; /* Màu vàng cho nút Hiển thị văn bản */
      }
      #showTextButton:hover {
        background-color: #e0a800; /* Màu vàng đậm khi hover */
      }
      #readOriginalButton {
        background-color: #17a2b8; /* Màu cyan cho nút Đọc văn bản gốc */
      }
      #readOriginalButton:hover {
        background-color: #117a8b; /* Màu cyan đậm khi hover */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Kiểm tra phát âm tiếng Nhật</h1>
      <textarea
        id="japaneseText"
        placeholder="Nhập câu tiếng Nhật"
        rows="5"
      ></textarea>
      <button id="showTextButton">Hiển thị văn bản</button>
      <button id="readOriginalButton" class="hidden">Đọc văn bản gốc</button>
      <button id="recordButton" class="hidden">Bắt đầu ghi âm</button>
      <button id="nextButton" class="hidden">Kế tiếp</button>
      <div id="result">
        <p id="originalText" class="hidden">Văn bản gốc: <span></span></p>
        <p id="recordingText" class="hidden">Đang ghi âm: <span></span></p>
        <p id="comparisonText" class="hidden">So sánh: <span></span></p>
      </div>
      <div id="score" class="hidden">Điểm phát âm: <span></span></div>
    </div>

    <script>
      const japaneseText = document.getElementById("japaneseText");
      const recordButton = document.getElementById("recordButton");
      const result = document.getElementById("result");

      let recognition;
      let isRecording = false;
      let finalTranscript = "";

      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "ja-JP";

        recognition.onresult = function (event) {
          let interimTranscript = "";
          for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            } else {
              interimTranscript += event.results[i][0].transcript;
            }
          }
          // Cập nhật kết quả tạm thời
          document.querySelector("#originalText span").textContent =
            japaneseText.value;
          document.querySelector("#recordingText span").textContent =
            finalTranscript + interimTranscript;
          document.getElementById("originalText").classList.remove("hidden");
          document.getElementById("recordingText").classList.remove("hidden");
        };

        recognition.onerror = function (event) {
          console.error("Lỗi nhận dạng giọng nói:", event.error);
        };

        recognition.onend = function () {
          if (isRecording) {
            recognition.start();
          }
        };
      } else {
        alert(
          "Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói. Vui lòng sử dụng Google Chrome, Edge hoặc Cốc Cốc"
        );
      }

      let sentences = []; // Mảng để lưu trữ các câu
      let currentSentenceIndex = 0; // Chỉ số câu hiện tại

      let voices = [];
      let utterance; // Biến để lưu đối tượng SpeechSynthesisUtterance

      function populateVoiceList() {
        voices = speechSynthesis.getVoices();
      }

      speechSynthesis.onvoiceschanged = populateVoiceList;

      // Thêm sự kiện click cho nút Hiển thị văn bản
      document
        .getElementById("showTextButton")
        .addEventListener("click", function () {
          const text = document.getElementById("japaneseText").value; // Lấy văn bản từ ô nhập liệu
          if (text.trim() === "") {
            alert("Vui lòng nhập văn bản trước khi hiển thị.");
            return;
          }
          sentences = text.split("\n"); // Tách các câu bằng dấu ngắt dòng
          updateOriginalText(sentences[currentSentenceIndex]); // Hiển thị câu đầu tiên

          // Hiển thị nút Bắt đầu ghi âm
          document.getElementById("recordButton").classList.remove("hidden");
        });

      // Thêm sự kiện click cho nút Đọc văn bản gốc
      document
        .getElementById("readOriginalButton")
        .addEventListener("click", function () {
          const text = document.querySelector("#originalText span").textContent; // Lấy văn bản gốc

          if (text.trim() === "") {
            alert("Chưa có văn bản gốc."); // Thông báo nếu chưa có văn bản
            return;
          }

          if (speechSynthesis.speaking) {
            // Nếu đang nói, dừng lại
            speechSynthesis.cancel();
          } else {
            // Nếu không đang nói, bắt đầu đọc
            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "ja-JP"; // Đặt ngôn ngữ là tiếng Nhật
            utterance.rate = 1; // Tốc độ
            utterance.pitch = 1; // Độ cao
            utterance.volume = 1; // Âm lượng

            // Chọn giọng nói (ví dụ: giọng đầu tiên trong danh sách)
            if (voices.length > 0) {
              utterance.voice =
                voices[Math.floor(Math.random() * voices.length)]; // Random chọn giọng
            }

            speechSynthesis.speak(utterance);
          }
        });

      // Cập nhật hiển thị văn bản gốc và hiển thị nút "Đọc văn bản gốc"
      function updateOriginalText(text) {
        document.querySelector("#originalText span").textContent = text; // Cập nhật văn bản gốc
        document.getElementById("originalText").classList.remove("hidden"); // Hiển thị văn bản gốc
        document
          .getElementById("readOriginalButton")
          .classList.remove("hidden"); // Hiển thị nút Đọc văn bản gốc
      }

      // Cập nhật hàm ghi âm để sử dụng updateOriginalText
      recordButton.addEventListener("click", function () {
        if (!isRecording) {
          if (japaneseText.value.trim() === "") {
            alert("Vui lòng nhập câu tiếng Nhật trước khi ghi âm.");
            return;
          }
          // Tách các câu bằng dấu ngắt dòng
          sentences = japaneseText.value.split("\n");
          finalTranscript = "";
          updateOriginalText(sentences[currentSentenceIndex]); // Hiển thị câu hiện tại
          document.querySelector("#recordingText span").textContent = "";
          document.getElementById("recordingText").classList.remove("hidden");
          document.getElementById("comparisonText").classList.add("hidden");

          // Đặt lại điểm cũ
          const scoreSpan = document.querySelector("#score span");
          scoreSpan.textContent = ""; // Xóa số điểm cũ
          document.getElementById("score").classList.add("hidden"); // Ẩn điểm

          recognition.start();
          recordButton.textContent = "Dừng ghi âm";
          isRecording = true;
        } else {
          recognition.stop();
          recordButton.textContent = "Bắt đầu ghi âm";
          isRecording = false;

          // Thêm thời gian chờ 1 giây trước khi so sánh văn bản
          setTimeout(() => {
            compareTexts(sentences[currentSentenceIndex], finalTranscript);
          }, 300); // 300 ms = 0,3 giây
        }
      });

      function compareTexts(original, spoken) {
        const originalChars = original.split("");
        const spokenChars = spoken.replace(/\s/g, "").split("");
        let comparisonHtml = "";
        let correctCount = 0; // Biến để đếm số ký tự đúng

        let i = 0;
        let j = 0;

        while (i < originalChars.length || j < spokenChars.length) {
          if (
            i < originalChars.length &&
            j < spokenChars.length &&
            originalChars[i] === spokenChars[j]
          ) {
            comparisonHtml += `<span class="correct">${originalChars[i]}</span>`;
            correctCount++; // Tăng số ký tự đúng
            i++;
            j++;
          } else if (i < originalChars.length) {
            // Kiểm tra nếu ký tự là "、" hoặc "。"
            if (originalChars[i] === "、" || originalChars[i] === "。") {
              comparisonHtml += `<span class="correct">${originalChars[i]}</span>`;
              correctCount++; // Tăng số ký tự đúng
            } else {
              comparisonHtml += `<span class="incorrect">${originalChars[i]}</span>`;
            }
            i++;
          } else {
            j++;
          }
        }

        document.querySelector("#comparisonText span").innerHTML =
          comparisonHtml;
        document.getElementById("comparisonText").classList.remove("hidden");

        // Tính toán và hiển thị điểm
        const scorePercentage = Math.round(
          (correctCount / originalChars.length) * 100
        ); // Làm tròn thành số nguyên
        const scoreSpan = document.querySelector("#score span");
        scoreSpan.textContent = scorePercentage + "%";

        // Áp dụng lớp CSS dựa trên điểm
        if (scorePercentage > 70) {
          scoreSpan.classList.add("score-good");
          scoreSpan.classList.remove("score-bad");
          document.getElementById("nextButton").classList.remove("hidden"); // Hiển thị nút Kế tiếp
        } else {
          scoreSpan.classList.add("score-bad");
          scoreSpan.classList.remove("score-good");
          document.getElementById("nextButton").classList.add("hidden"); // Ẩn nút Kế tiếp
        }

        document.getElementById("score").classList.remove("hidden");
      }

      document
        .getElementById("nextButton")
        .addEventListener("click", function () {
          currentSentenceIndex++; // Tăng chỉ số câu hiện tại
          if (currentSentenceIndex < sentences.length) {
            finalTranscript = ""; // Đặt lại bản ghi cuối
            document.querySelector("#originalText span").textContent =
              sentences[currentSentenceIndex]; // Hiển thị câu tiếp theo
            document.querySelector("#recordingText span").textContent = "";
            document.getElementById("comparisonText").classList.add("hidden");
            document.getElementById("score").classList.add("hidden"); // Ẩn điểm
            document.getElementById("nextButton").classList.add("hidden"); // Ẩn nút Kế tiếp

            // Reset kết quả hiển thị
            const scoreSpan = document.querySelector("#score span");
            scoreSpan.textContent = ""; // Xóa số điểm cũ
            document.getElementById("originalText").classList.remove("hidden");
            document.getElementById("recordingText").classList.remove("hidden");
          } else {
            alert("Đã hoàn thành tất cả các câu!");
            // Có thể thêm logic để reset hoặc làm gì đó khác ở đây
          }
        });
    </script>
  </body>
</html>
